#!/usr/bin/env node

var Component = require('..');
var fs = require('fs');
var logger = require('../lib/logger');
var normalize = require('../lib/spec').normalize;
var path = require('path');
var program = require('commander');
var semver = require('semver');

/**
 * Options.
 */

program
  .usage('[package ...]')
  .option('-d, --dev', 'install development dependencies alongside regular ones')
  .option('-o, --out <dir>', 'set the destination directory to install dependencies')
  .option('-v, --verbose', 'output verbose logging while installing')

/**
 * Examples.
 */

program.on('--help', function(){
  console.log('  Examples:');
  console.log();
  console.log('    # install dependencies from ./component.json');
  console.log('    $ component install');
  console.log();
  console.log('    # install a single component as a dependency');
  console.log('    $ component install component/tip');
  console.log();
  console.log('    # install several components at once');
  console.log('    $ component install component/tip component/popover');
  console.log();
  console.log('    # install a specific version of a component');
  console.log('    $ component install component/tip@1.0.0');
  console.log();
  console.log('    # install regular and development dependencies from ./component.json');
  console.log('    $ component install --dev');
  console.log();
  console.log('    # install a single component as a development dependency');
  console.log('    $ component install --dev component/tip');
  console.log();
  process.exit();
});

/**
 * Parse.
 */

program.parse(process.argv);

/**
 * Padding.
 */

console.log();
process.on('exit', function(){ console.log(); });

/**
 * Settings.
 */

var packages = program.args;
var dev = program.dev;
var out = program.out;
var verbose = program.verbose;

/**
 * Component.
 */

try {
  var component = new Component(process.cwd());
} catch (e) {
  logger.fatal(e);
}

if (dev) component.development();
if (out) component.installTo(out);

/**
 * Without dependencies, install everything from the component.json in the
 * current working directory.
 */

if (!packages.length) {
  listen(component)
  component.install(function(err){
    if (err) logger.fatal(err);
  });
  return;
}

/**
 * Install each dependency in the list of `packages`, and save them to the
 * component.json in the current directory.
 */

component.localDependencies(function(err, installed){
  if (err) logger.fatal(err);

  var unpinned = [];
  var repos = [];
  var existing = component.json();
  var json = component.json();
  var conf = normalize.json(json, dev);
  var deps = conf.dependencies;

  packages.forEach(function(pkg){
    try {
      var repo = normalize.repository(pkg);
      var key = repo.string;
    } catch (e) {
      logger.fatal(e);
    }

    repos.push(key);

    // the only case when we don't want to update the version is if the package
    // was already installed and a new version wasn't supplied
    if (repo.version) {
      deps[key] = repo.version;
    } else if (!installed[key]) {
      deps[key] = '*';
      unpinned.push(key);
    }
  });

  // set the updated config so that install will pick them up
  component.json(json);

  // when the download completes, if the package was unpinned, check the final
  // version that was resolved and pin it with "~"
  component.on('download', function(repo, version){
    if (~unpinned.indexOf(repo)) deps[repo] = '~' + version;
  });

  listen(component, repos);

  component.install(function(err){
    if (!err) return component.json(json);
    component.json(existing);
    logger.fatal(err);
  });
});

/**
 * Attach listeners to the install steps, optionally filtering by `repos`.
 *
 * @param {Emitter} component
 * @param {Array} repos (optional)
 */

function listen(component, repos){

  component.on('exists', function(repo, version){
    if (match(repo)) logger.log('exists', repo + '@' + version);
  });

  component.on('downloading', function(repo, version){
    if (match(repo)) logger.log('fetch', repo + '@' + version);
  });

  component.on('download', function(repo, version){
    if (match(repo)) logger.log('install', repo + '@' + version);
  });

  if (!verbose) return;

  component.on('downloading file', function(repo, version, file){
    if (match(repo)) logger.log('fetch', file + ' from ' + repo + '@' + version);
  });

  component.on('download file', function(repo, version, file){
    if (match(repo)) logger.log('install', file + ' from ' + repo + '@' + version);
  });

  component.on('versions', function(repo){
    if (match(repo)) logger.log('versions', repo);
  });

  function match(repo){
    if (!repos) return true;
    return ~repos.indexOf(repo);
  }
}